# ===========================
# ğŸ”¹ 1. ãƒ“ãƒ«ãƒ‰ç’°å¢ƒ (builder)
# ===========================
FROM ruby:3.3.0 AS builder

# ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
ENV RAILS_ENV=production \
    BUNDLE_PATH=/gems \
    BUNDLE_JOBS=4 \
    BUNDLE_RETRY=3

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update -qq && apt-get install -y --no-install-recommends \
  build-essential \
  libpq-dev \
  nodejs \
  yarn \
  imagemagick \
  tzdata \
  redis-tools \
  postgresql-client \
  && rm -rf /var/lib/apt/lists/*

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
WORKDIR /app

# ä¾å­˜é–¢ä¿‚ã‚’å…ˆã«ã‚³ãƒ”ãƒ¼ (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åˆ©ç”¨)
COPY Gemfile Gemfile.lock ./
RUN gem install bundler -v 2.5.11 && bundle install --jobs 4 --retry 3

# Node.js ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY package.json yarn.lock ./
RUN yarn install --check-files

# ===========================
# ğŸ”¹ 2. ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ç’°å¢ƒ (runtime)
# ===========================
FROM ruby:3.3.0 AS runtime

# ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
ENV RAILS_ENV=production \
    RAILS_LOG_TO_STDOUT=true \
    RAILS_SERVE_STATIC_FILES=true \
    SECRET_KEY_BASE=your_secret_key_here

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã¿ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update -qq && apt-get install -y --no-install-recommends \
  libpq-dev \
  nodejs \
  yarn \
  imagemagick \
  tzdata \
  postgresql-client \
  && rm -rf /var/lib/apt/lists/*

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
WORKDIR /app

# `builder` ã‚¹ãƒ†ãƒ¼ã‚¸ã‹ã‚‰ Gem ã‚’ã‚³ãƒ”ãƒ¼
COPY --from=builder /gems /gems
ENV BUNDLE_PATH=/gems

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
COPY . .

# `builder` ã‚¹ãƒ†ãƒ¼ã‚¸ã§ Yarn ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚‚ã‚³ãƒ”ãƒ¼
COPY --from=builder /app/node_modules /app/node_modules

# ã‚¢ã‚»ãƒƒãƒˆã‚’ãƒ—ãƒªã‚³ãƒ³ãƒ‘ã‚¤ãƒ« (æœ¬ç•ªç’°å¢ƒ)
RUN bundle exec rails assets:precompile

# ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®š
COPY docker/entrypoint.sh /usr/bin/entrypoint.sh
RUN chmod +x /usr/bin/entrypoint.sh

# Web ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
ENTRYPOINT ["entrypoint.sh"]
CMD ["bundle", "exec", "rails", "server", "-b", "0.0.0.0"]
