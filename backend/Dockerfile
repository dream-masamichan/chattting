# ==============================
# 1ï¸âƒ£ Build Stage (builder) - ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# ==============================
FROM ruby:3.3.0 AS builder

# ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
ENV RAILS_ENV=production \
    BUNDLE_JOBS=4 \
    BUNDLE_RETRY=3 \
    BUNDLE_PATH=/gems \
    NODE_ENV=production \
    YARN_CACHE_FOLDER=/yarn_cache

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update -qq && apt-get install -y --no-install-recommends \
  build-essential \
  libpq-dev \
  nodejs \
  yarn \
  imagemagick \
  tzdata \
  redis-tools \
  postgresql-client \
  && rm -rf /var/lib/apt/lists/*

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
WORKDIR /app

# Bundler ã‚’æœ€æ–°åŒ–
RUN gem install bundler -v 2.5.11

# Gemfile ã‚’å…ˆã«ã‚³ãƒ”ãƒ¼ã—ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ´»ç”¨
COPY Gemfile Gemfile.lock ./

# `bundle install` (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ´»ç”¨)
RUN bundle config set without 'development test' && bundle install --jobs=${BUNDLE_JOBS} --retry=${BUNDLE_RETRY}

# ==============================
# 2ï¸âƒ£ Runtime Stage (Final) - æœ¬ç•ªç’°å¢ƒç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
# ==============================
FROM ruby:3.3.0-slim

# `non-root` ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–)
RUN useradd -m appuser

# ç’°å¢ƒå¤‰æ•°ã®è¨­å®š (å®Ÿè¡Œç’°å¢ƒå‘ã‘)
ENV RAILS_ENV=production \
    BUNDLE_JOBS=4 \
    BUNDLE_RETRY=3 \
    BUNDLE_PATH=/gems \
    RAILS_SERVE_STATIC_FILES=true \
    RAILS_LOG_TO_STDOUT=true \
    NODE_ENV=production

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¨­å®š
WORKDIR /app

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æœ€å°é™ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update -qq && apt-get install -y --no-install-recommends \
  libpq-dev \
  imagemagick \
  tzdata \
  redis-tools \
  postgresql-client \
  && rm -rf /var/lib/apt/lists/*

# `builder` ã‚¹ãƒ†ãƒ¼ã‚¸ã‹ã‚‰ gem ã‚’ã‚³ãƒ”ãƒ¼ (è»½é‡åŒ–)
COPY --from=builder /gems /gems

# `non-root` ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¤‰æ›´ (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Š)
USER appuser

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
COPY . .

# SHELL ã‚’ `bash -c` ã«å¤‰æ›´ (ã‚ˆã‚Šå®‰å®šã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ)
SHELL ["/bin/bash", "-c"]

# ==============================
# ğŸ“ ã“ã“ã§ `entrypoint.sh` ã‚’ `/app/` ã«ã‚³ãƒ”ãƒ¼
# ==============================
COPY docker/entrypoint.sh /app/entrypoint.sh

# å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸
USER root
RUN chmod +x /app/entrypoint.sh

# `appuser` ã«æˆ»ã™
USER appuser

# ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®š
ENTRYPOINT ["/app/entrypoint.sh"]

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® Rails ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚³ãƒãƒ³ãƒ‰
CMD ["bundle", "exec", "rails", "server", "-b", "0.0.0.0"]
